name: æ¯æ—¥è‚¡ç¥¨åˆ†æ

on:
  # å®šæ—¶è§¦å‘ - æ¯å¤©åŒ—äº¬æ—¶é—´ 18:00 (UTC 10:00)
  schedule:
    - cron: '0 10 * * 1-5'     # å‘¨ä¸€åˆ°å‘¨äº”

  # æ‰‹åŠ¨è§¦å‘ - æ”¯æŒä¸ªè‚¡å¿«é€ŸæŸ¥è¯¢
  workflow_dispatch:
    inputs:
      stock_code:
        description: 'ä¸ªè‚¡æŸ¥è¯¢ (å¦‚ 002897, 600519)'
        required: false
        default: ''
      mode:
        description: 'è¿è¡Œæ¨¡å¼'
        required: true
        default: 'full'
        type: choice
        options:
          - full          # å®Œæ•´åˆ†æ
          - market-only   # ä»…å¤§ç›˜å¤ç›˜
          - stocks-only   # ä»…è‚¡ç¥¨åˆ†æ

concurrency:
  group: stock-analysis
  cancel-in-progress: false

jobs:
  analyze:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: åˆ›å»ºå¿…è¦ç›®å½•
        run: |
          mkdir -p data logs reports
      
      - name: æ‰§è¡Œè‚¡ç¥¨åˆ†æ
        env:
          # === æ ¸å¿ƒ API é…ç½® ===
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_MODEL: ${{ vars.GEMINI_MODEL || secrets.GEMINI_MODEL || 'gemini-2.0-flash' }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          
          # === ã€æ ¸å¿ƒä¿®å¤1ã€‘è§£å†³ 429 é¢‘ç‡æŠ¥é”™ ===
          GEMINI_REQUEST_DELAY: '15' 
          
          # === é‚®ä»¶é…ç½® ===
          EMAIL_SENDER: ${{ vars.EMAIL_SENDER || secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVERS: ${{ vars.EMAIL_RECEIVERS || secrets.EMAIL_RECEIVERS }}
          
          # === ã€æ ¸å¿ƒä¿®å¤2ã€‘ä¿®å¤å¿«æ·æŸ¥è¯¢ä¸ªè‚¡é€»è¾‘ ===
          # ä¼˜å…ˆçº§ï¼šæ‰‹åŠ¨è¾“å…¥ > å˜é‡é…ç½® > é»˜è®¤èŒ…å°
          STOCK_LIST: ${{ github.event.inputs.stock_code || vars.STOCK_LIST || secrets.STOCK_LIST || '600519' }}
          
          # === è¿è¡Œå‚æ•° ===
          REPORT_TYPE: 'full'
          SINGLE_STOCK_NOTIFY: 'true'
          MARKET_REVIEW_ENABLED: 'true'
          
        run: |
          MODE="${{ github.event.inputs.mode || 'full' }}"
          INPUT_CODE="${{ github.event.inputs.stock_code }}"
          
          echo "=========================================="
          echo "ğŸš€ æ™ºèƒ½æ‰«æç³»ç»Ÿ [æ— é”™è¯¯ç¨³å®šç‰ˆ]"
          echo "=========================================="
          
          # å¦‚æœç”¨æˆ·æ‰‹åŠ¨è¾“å…¥äº†ä»£ç ï¼Œå¼ºåˆ¶è¿›å…¥ä¸ªè‚¡æ¨¡å¼ï¼Œæé«˜æ•ˆç‡
          if [ -n "$INPUT_CODE" ]; then
            echo "ğŸ¯ å‘ç°æ‰‹åŠ¨è¾“å…¥ï¼Œæ­£åœ¨ä¸“é¡¹åˆ†æ: $INPUT_CODE"
            python main.py --no-market-review
          elif [ "$MODE" = "market-only" ]; then
            python main.py --market-review
          elif [ "$MODE" = "stocks-only" ]; then
            python main.py --no-market-review
          else
            # ä¸‹åˆ6ç‚¹è‡ªåŠ¨è¿è¡Œèµ°è¿™é‡Œ
            python main.py
          fi
      
      - name: ä¸Šä¼ åˆ†ææŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: analysis-reports-${{ github.run_number }}
          path: |
            reports/
            logs/
          retention-days: 7
